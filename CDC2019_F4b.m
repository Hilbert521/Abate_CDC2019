%  
% To Appear in: Monitor-Based  Runtime  Assurance  for  Temporal  Logic 
%               Specifications, CDC 2019
%
% Author:       Will Stuckey
% Editted:      Matt Abate (8/8/2019)
%
% Description: This script generates Figure 4b in the paper
%

clc; clear all; clf;

% Constant graph artifacts
clocktower_loc = 2.54;      % Location of Clock Tower
fast_thresh = 2.0;          % Speed Requirement

safe_region_m = -0.74;
safe_region_b = 1.86;

v_plot_upper = 3.7;
x_plot_upper = 3.5;
     
% Experimental Data
position = 1.0216832842145647;
velocity = 1.5406487912547828;
assd_ir =   {[1.0216832842145647, 1.5406487912547828], ...
             [1.6449704820282602, 2.4931487912547827; ...
              1.6224704820282603, 2.4031487912547829], ...
             [2.461382679841956, 3.355648791254783; ...
              2.4388826798419561, 3.2656487912547827; ...
              2.483882679841956, 3.3556487912547825; ...
              2.506382679841956, 3.4456487912547829], ...
             [3.2989198776556519, 3.1701487912547828; ...
              3.3264198776556517, 3.2801487912547826; ...
              3.2589198776556518, 3.1901487912547828; ...
              3.2139198776556519, 3.1001487912547825; ...
              3.1864198776556516, 2.9901487912547826; ...
              3.2539198776556515, 3.0801487912547825]};
               
                
perf_ir =   {[1.5935697316240105, 1.4642076897493903; ...
              1.5660697316240104, 1.3542076897493902], ...
             [1.8632466540613579, 1.1887076897493902; ...
              1.8357466540613578, 1.0787076897493901; ...
              1.890746654061358, 1.1887076897493902; ...
              1.9182466540613581, 1.2987076897493903], ...
             [2.0640485764987053, 0.91320768974939015; ...
              2.0365485764987055, 0.80320768974939005; ...
              2.1190485764987055, 0.91320768974939015; ...
              2.1740485764987056, 1.0232076897493902; ...
              2.2015485764987055, 1.1332076897493903; ...
              2.1190485764987055, 1.0232076897493902], ...
             [2.1684754989360528, 0.52770768974938997; ...
              2.2784754989360532, 0.63770768974939007; ...
              2.3609754989360532, 0.74770768974939017; ...
              2.4159754989360529, 0.85770768974939027; ...
              2.4434754989360532, 0.96770768974939037; ...
              2.3334754989360529, 0.85770768974939027; ...
              2.2509754989360529, 0.74770768974939017; ...
              2.1959754989360531, 0.63770768974939007], ...
             [2.2315274213734004, 0.25220768974938995;
              2.3690274213734006, 0.36220768974939005;
              2.4790274213734009, 0.47220768974939015;
              2.5615274213734005, 0.58220768974939019;
              2.6165274213734007, 0.69220768974939029;
              2.644027421373401, 0.80220768974939038;
              2.5065274213734003, 0.69220768974939029;
              2.3965274213734005, 0.58220768974939019;
              2.3140274213734005, 0.47220768974939009;
              2.2590274213734003, 0.36220768974938999]};
               

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Create Figure
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Initial Plot Setup
figure(1)
hold on
grid on
set(gca,'FontSize', 17, 'TickLabelInterpreter','latex');
title('Assuring F1/10 with Human Driver', 'Interpreter','latex');
axis([0 x_plot_upper 0 v_plot_upper]);
xlabel('Position (m)', 'Interpreter','latex');
ylabel('Velocity (m/s)', 'Interpreter','latex');

% Plot Regions 
plot([0 x_plot_upper], [fast_thresh fast_thresh], 'k--', 'LineWidth', 1.3);
plot([0 2.24], [1.66 0], 'k');

% Plot Safe Regions
pat_safe_verts = [clocktower_loc, fast_thresh;
                  clocktower_loc, v_plot_upper;
                  x_plot_upper, v_plot_upper;
                  x_plot_upper, fast_thresh];
pat_safe_fac = [1, 2, 3, 4];
patch('vertices', pat_safe_verts, ...
        'faces', pat_safe_fac, ...
        'FaceColor', 'g', ...
        'FaceAlpha', 0.2, ...
        'LineWidth', 1.3);
    
pat_assd_verts = [0, 0;
                  0, 1.66;
                  2.24, 0];
pat_assd_fac = [1, 2, 3];
patch('vertices', pat_assd_verts, ...
      'faces', pat_assd_fac, ...
      'FaceColor', 'g', ...
      'FaceAlpha', 0.2, ...
      'LineWidth', 1.3);
    
% Plot Unsafe Regions
pat_usafe_verts = [clocktower_loc, 0;
                    clocktower_loc, fast_thresh;
                    x_plot_upper, fast_thresh;
                    x_plot_upper, 0];
pat_usafe_fac = [1, 2, 3, 4];
patch('vertices', pat_usafe_verts, ...
      'faces', pat_usafe_fac, ...
      'FaceColor', 'r', ...
      'FaceAlpha', 0.2, ...
      'LineWidth', 1.3);

% Label Regions
font_size = 17;
text_space = 0.1;
vert_scale = 1.5;
text(0+text_space,0+text_space*vert_scale, ...
     '\bf{Region 1}', ...
     'Interpreter','latex', ...
     'FontSize',font_size);
text(0+text_space,fast_thresh-text_space*vert_scale, ...
     '\bf{Region 2}', ...
     'Interpreter','latex', ...
     'FontSize',font_size);
text(0+text_space,fast_thresh+text_space*vert_scale, ...
     '\bf{Region 3}', ...
     'Interpreter','latex', ...
     'FontSize',font_size);
text(x_plot_upper-text_space,fast_thresh+text_space*vert_scale,...
     '\bf{Region 4}', ...
     'Interpreter','latex', ...
     'FontSize',font_size,'HorizontalAlignment','right');
text(x_plot_upper-text_space,fast_thresh-text_space*vert_scale, ...
     '\bf{Region 5}', ...
     'Interpreter','latex', ...
     'FontSize',font_size,'HorizontalAlignment','right');

% Plot Reachable sets of the system under the backup control policy
[~, tl_c] = size(assd_ir);
for i = 1:tl_c
    p_dat = assd_ir{i};
    [r, c] = size(p_dat);
    fac = 1:(r);
    fac_col = 'g';
    fac_a = 0.2;
    patch('vertices', p_dat, ...
        'faces', fac, ...
        'FaceColor', fac_col, ...
        'FaceAlpha', fac_a, ...
        'Marker', 'o', ...
        'MarkerFaceColor', 'g', ...
        'LineWidth', 1.2);
end

% Plot Reachable sets of the system under the performance control policy
[~, tl_c] = size(perf_ir);
for i = 1:tl_c
    p_dat = perf_ir{i};
    [r, c] = size(p_dat);
    fac = 1:(r);
    fac_col = 'y';
    fac_a = 0.2;
    patch('vertices', p_dat, ...
        'faces', fac, ...
        'FaceColor', fac_col, ...
        'FaceAlpha', fac_a, ...
        'Marker', 'o', ...
        'MarkerFaceColor', 'y', ...
        'LineWidth', 1.2);
end


% Plot Current Car Location
plot(position, velocity, 'x');
scatter(position, velocity, 'MarkerEdgeColor','k',...
              'MarkerFaceColor','m')

